---
title: "Psalmswordpairs"
author: "sung inkyung"
date: '2019 8 7 '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## sources: [Textminng](http://uc-r.github.io/tidy_text)
```{r}
library(tidyverse)
library(tidytext)
```

```{r}
Psalms <- readr::read_csv("C:/Users/inkyscope/Documents/projects/data/bible_kjv_new.csv") %>% 
  filter(book == "Psalms") 
```

```{r}
tidy_psalms <- Psalms %>%
  mutate(book =factor(book)) %>% 
  select(book, chapter, text) %>% 
  unnest_tokens(word, text) %>%
  anti_join(stop_words) %>%
  group_by(word, book, chapter) %>%
  count(book, word, sort = TRUE) %>% 
  ungroup() %>% 
  filter(!word %in% c("thou", "thy", "thine", "hast", "art",
                      "shalt", "thee", "hath", "ye", "lord", "god" )) 
```

```{r}
tidy_psalms %>% 
  count(word, sort = TRUE) %>% 
  filter( n > 40) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal()
```

```{r}
psalms_words <- tidy_psalms %>% 
  bind_tf_idf(word, chapter, n) %>% 
  arrange(desc(tf_idf))

psalms_words
```

```{r}
psalms_words %>% 
  arrange(desc(tf_idf)) %>% 
  mutate(word = factor(word, levels = rev(unique(word)))) %>% 
  group_by(book) %>% 
  top_n(15, tf_idf) %>% 
  filter(!word %in% c("praise", "aha")) %>% 
  ungroup() %>% 
  ggplot(aes(word, tf_idf)) +
  geom_col(show.legend = FALSE) +
  labs(x = NULL,
       y = "tf-idf") +
  coord_flip() +
  theme_minimal()
```

```{r}
Psalms_divided <- psalms_words %>% 
  mutate(
    chapter = case_when(
      chapter < 42 ~ "Book1",
      chapter < 73 ~ "Book2",
      chapter < 90 ~ "Book3",
      chapter < 107 ~ "Book4",
      chapter <= 150 ~ "Book5",
      TRUE ~ as.character(chapter)))
```

```{r}
Psalms_divided %>% 
  arrange(desc(tf_idf)) %>% 
  group_by(chapter) %>% 
  top_n(15, tf_idf)%>% 
  ungroup() %>% 
  mutate(word = drlib::reorder_within(word, tf-idf, chapter)) %>% 
  ggplot(aes(word, tf_idf, fill = chapter)) +
  geom_col(stat = "identity",
           alpha = .7,
           show.legend = FALSE) +
  labs(x = NULL,
       y = "tf-idf") +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~chapter, ncol = 2, scales = "free") +
  drlib::scale_x_reordered() +
  coord_flip() +
  theme_minimal()
```

```{r bigrams}
Psalms_books <- Psalms %>% 
  mutate(
    chapter = case_when(
      chapter < 42 ~ "Book1",
      chapter < 73 ~ "Book2",
      chapter < 90 ~ "Book3",
      chapter < 107 ~ "Book4",
      chapter <= 150 ~ "Book5",
      TRUE ~ as.character(chapter)))
```

```{r}
psalms_bigrams <- Psalms_books %>% 
  unnest_tokens(bigram, text, token = "ngrams", n = 2) %>% 
  filter(!bigram %in% c("thou hast", "thou art", "thou shalt", "thou wilt")) %>% 
  separate(bigram, c("word1", "word2", sep = " ")) %>% 
  filter(!word1 %in% stop_words$word,
         !word2 %in% stop_words$word)%>% 
  count(chapter, word1, word2, sort = TRUE) %>% 
  unite(bigram, word1, word2, sep = " ")
```

```{r}
psalms_bigrams %>% 
  arrange(desc(n)) %>% 
  group_by(chapter) %>% 
  top_n(10) %>% 
  ungroup() %>% 
  mutate(bigram = drlib::reorder_within(bigram, n, chapter)) %>% 
  ggplot(aes(bigram, n, fill = chapter)) +
  geom_col(stat = "identity", 
           alpha = .7,
           show.legend = FALSE) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~chapter, ncol = 2, 
             scales = "free") +
  drlib::scale_x_reordered()+
  coord_flip() +
  theme_minimal()
```

```{r}
# Analyzing bigrams

bigrams_tf_idf <- psalms_bigrams %>% 
  count(chapter, bigram, sort = TRUE) %>% 
  bind_tf_idf(bigram, chapter, n) %>% 
  arrange(desc(tf_idf))
```

```{r}
bigrams_tf_idf %>% 
  group_by(chapter) %>% 
  sample_n(10, wt = tf_idf) %>% 
  ungroup() %>% 
  mutate(chapter = factor(chapter) %>% 
           forcats::fct_rev()) %>% 
  ggplot(aes(drlib::reorder_within(bigram, tf_idf, chapter, na.rm = TRUE), 
             tf_idf, fill =chapter)) +
  geom_bar(stat = "identity", alpha = .7, 
           show.legend = FALSE) +
  labs(title = "bigrams with the highest tf-idf in Psalms", 
       x = " ",
       y = "tf-idf") +
  drlib::scale_x_reordered() +
  facet_wrap(~ chapter, ncol = 2, scales = "free") +
  coord_flip()+
  theme_minimal()
```

```{r}
psalms_bigrams <- Psalms_books %>% 
  unnest_tokens(bigram, text, token = "ngrams", n = 2) 

bigrams_separated <-  psalms_bigrams %>% 
  separate(bigram, c("word1", "word2"), sep = " ") 
```

```{r}

bigrams_separated%>% 
  filter(word1 == "not") %>% 
  count(word1, word2, sort = TRUE)


not_words <- bigrams_separated %>% 
  filter(word1 == "not") %>% 
  inner_join(get_sentiments("afinn"), 
             by = c(word2 = "word")) %>% 
  count(word2, score, sort = TRUE) 

not_words
```

```{r}
not_words %>% 
  mutate(contribution = n * score) %>% 
  arrange(desc(abs(contribution))) %>% 
  head(20) %>% 
  ggplot(aes(reorder(word2, contribution), n*score, 
             fill = n*score > 0))+
  geom_col(stat = "identity",
           show.legend = FALSE) +
  coord_flip()+
  scale_fill_manual(values = c("#aa0055", "#ffd700")) +
  labs(title = "The 20 words preceded by 'not' based on the contribution to sentiment values",
       x = "words preceded by \"not\"",
       y = "Sentiment value * number of occurrences") +
  theme_minimal()
```

```{r}
negation_words <- c("not", "no", "never", "without")

negated_words <- bigrams_separated %>% 
  filter(word1 %in% negation_words) %>%  
  inner_join(get_sentiments("afinn"), 
             by = c(word2 = "word")) %>% 
  count(word1, word2, score, sort = TRUE)

negated_words
```

```{r}
negated_words %>% 
  mutate(contribution = n*score) %>% 
  arrange(desc(abs(contribution))) %>% 
  group_by(word1) %>% 
  top_n(7, abs(contribution)) %>% 
  ggplot(aes(drlib::reorder_within(word2, contribution, word1), contribution, fill = contribution > 0)) +
  geom_col(stat = "identity", 
           alpha = .7,
           show.legend = FALSE) +
  scale_fill_manual(values = c("#aa0055", "#ffd700")) +
  labs(title = "The 7 words preceded by 'not', 'no', 'never', 'without' based on the contribution to sentiment values",
       x = "words preceded by \"not\"",
       y = "Sentiment score * # of occurrences") +
    drlib::scale_x_reordered() +
  facet_wrap(~word1, scales = "free") +
  coord_flip() +
  theme_minimal()
```

```{r bigram Networks}
library(igraph)
library(ggraph)

count_bigrams <- function(dataset) {
  dataset %>%
    unnest_tokens(bigram, text, token = "ngrams", n = 2) %>%
    separate(bigram, c("word1", "word2"), sep = " ") %>%
    filter(!word1 %in% stop_words$word,
           !word2 %in% stop_words$word,
           !word1 %in% c("thou", "thy", "thine", "shalt", "art", "hath", "wilt", "hast", "ye"))%>%
    count(word1, word2, sort = TRUE)
}

visualize_bigrams <- function(bigrams) {
  set.seed(2019)
  a <- grid::arrow(type = "closed", 
                   length = unit(.15, "inches"))
  
  bigrams %>%
    graph_from_data_frame() %>%
    ggraph(layout = "fr") +
    geom_edge_link(aes(edge_alpha = n), show.legend = FALSE, arrow = a) +
    geom_node_point(color = "#ffaa55", size = 3) +
    geom_node_text(aes(label = name), vjust = 1, hjust = 1) +
    theme_void()
}
```

```{r}
library(cowplot)

psalms_bigrams <- Psalms %>%
  count_bigrams()

# filter out rare combinations, as well as digits
psalms_bigrams %>%
  filter(n > 3,
         !str_detect(word1, "\\d"),
         !str_detect(word2, "\\d")) %>%
  visualize_bigrams() +
  labs(title = "Common bigrams in the Psalms from King James Bible") +
  theme(plot.background =  element_rect(fill = "aliceblue"))


ggsave("C:/Users/inkyscope/Documents/projectR/dvscope/figures/Common bigrams in the Psalms from King James Bible.png")

```

```{r Counting and correlating among sections}
library(widyr)

psalms_chapter_words <- Psalms %>% 
  mutate(chapter = row_number() %/% 10) %>% 
  filter(chapter > 0) %>% 
  unnest_tokens(word, text) %>% 
  filter(!word %in% stop_words$word) %>% 
  select(-c("citation", "verse"))

psalms_chapter_words
```

```{r}
# count words co-occuring within chapters
word_pairs <- psalms_chapter_words %>% 
  pairwise_count(word, chapter, sort = TRUE)

word_pairs
```

```{r}
word_pairs %>% 
  filter(item1 == "morning")
```

```{r}
word_cors <- psalms_chapter_words %>% 
  group_by(word) %>% 
  filter(n()>20) %>% 
  pairwise_cor(word, chapter, sort = TRUE)
```

```{r}
word_cors %>% 
  filter(item1 == "word")
```

```{r}
word_cors %>% 
  filter(item1 %in% c("word", "mercy", "mouth", "enemy")) %>% 
  group_by(item1) %>% 
  top_n(8) %>% 
  ungroup() %>% 
  mutate(item2 = fct_reorder(item2, correlation)) %>% 
  ggplot(aes(item2, correlation, fill = item1)) +
  geom_bar(stat = "identity",
           alpha = .7,
           show.legend = FALSE) + 
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~item1, scales = "free") +
  coord_flip() +
  labs(title = "Words from Psalms that were most correlated with selected words",
       x = "",
       y= "correlation ") +
  theme_minimal()
```

```{r}
set.seed(2019)

word_cors %>%  
  filter(correlation > .3,
         !item1 %in% c("thou", "thy", "thee", "thine", "shalt", "art", "hath", "wilt", "hast", "ye")) %>% 
  graph_from_data_frame() %>% 
  ggraph(layout = "fr") + # graphopt
  geom_edge_link(aes(edge_alpha = correlation,
                     edge_width = correlation), 
                 edge_color = "#ffaa55")+
  geom_node_point( size = 3) +
  geom_node_text(aes(label = name), 
                 repel = TRUE,
                 point.padding = unit(0.2, "lines")) +
  labs(title = "Pairwise correlation in Psalms ",
       subtitle = "Correlated words appearing within the same 10-line verses")+
  theme_void()

ggsave("C:/Users/inkyscope/Documents/projectR/dvscope/figures/Word_pairs in Psalm.png")
```
